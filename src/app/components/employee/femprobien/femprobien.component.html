<igb-navbar></igb-navbar>
<div class="container content">
  <h3>Femprobien</h3>
  <div class="alert alert-danger text-center error-alert" role="alert" *ngIf="errorMessage">
    {{errorMessage}}
  </div>
  <div class="alert alert-success success-alert" role="alert" *ngIf="successMessage">
    {{successMessage}}
  </div>
  <!-- Navegación de pestañas -->
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link" [class.active]="adminTab === 'datosIngreso'"
        (click)="adminTab = 'datosIngreso'; clearError()">INGRESO</a>
    </li>
    <ng-container *ngIf="isAdmin">
      <li class="nav-item">
        <a class="nav-link" [class.active]="adminTab === 'busqueda'"
          (click)="adminTab = 'busqueda'; clearError()">BUSCAR ASOCIADO</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="adminTab === 'solicitudes'"
          (click)="adminTab = 'solicitudes'; clearError()">SOLICITUDES DE AFILIACION</a>
      </li>
    </ng-container>
  </ul>
  <!-- Contenido de pestañas -->
  <div class="tab-content mt-3">
    <!-- ============================ -->
    <!-- PESTAÑA: DATOS DE INGRESO -->
    <!-- ============================ -->
    <div *ngIf="adminTab === 'datosIngreso'">
      <div class="main-container">
        <div class="tarjeta-ingreso-agrupada" *ngIf="vista !== 'perfil'">
          <div class="ingreso-card">
            <h4>Datos de Ingreso</h4>
            <table class="table">
              <tr>
                <th>Número Documento</th>
                <td>
                  <input type="number" id="documento" class="form-control" [(ngModel)]="documento"
                    [readonly]="validado || mostrarFormularioAfiliado" placeholder="Ingrese su documento">
                </td>
              </tr>
              <tr>
                <th>Fecha Nacimiento</th>
                <td>
                  <input type="date" id="fechaNacimiento" class="form-control" [(ngModel)]="fechaNacimiento"
                    [readonly]="validado || mostrarFormularioAfiliado">
                </td>
              </tr>
            </table>
            <div class="employee-actions">
              <button type="button" class="btn btn-primary" (click)="validarEmpleado()"
                [disabled]="!documento || !fechaNacimiento || validado">
                Validar
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancelar()">Cancelar</button>
            </div>
            <div class="nuevo-afiliado-exterior mt-3" *ngIf="!validado">
              <p class="nuevo-afiliado-msg text-center">
                ¿No perteneces al fondo?<br><strong>Haz click en el botón de abajo para asociarte.</strong>
              </p>
              <div class="employee-actions text-center">
                <button *ngIf="!mostrarFormularioAfiliado" type="button" class="btn btn-success"
                  (click)="toggleFormularioAfiliado(); clearError()">
                  Nuevo Asociado
                </button>
                <div *ngIf="mostrarFormularioAfiliado" class="botones-accion-formulario">
                  <button type="button" class="btn btn-success mr-2" (click)="guardarNuevoAfiliado()"
                    [disabled]="isSubmitting">
                    {{isSubmitting ? 'Enviando...' : 'Enviar'}}
                  </button>
                  <button type="button" class="btn btn-secondary" (click)="limpiarFormularioAfiliado()"
                    [disabled]="!hayDatosEnFormulario()">
                    Borrar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Caja: Datos del Empleado -->
        <div class="card-box" *ngIf="validado && datosEmpleado">
          <table class="table">
            <tr>
              <th>Nombre Completo</th>
              <td>{{datosEmpleado?.nomAso}} {{datosEmpleado?.ap1Aso}} {{datosEmpleado?.ap2Aso}}</td>
            </tr>
            <tr>
              <th>Fecha Afiliación</th>
              <td>{{datosEmpleado?.fecAfi | date:'dd/MM/yyyy'}}</td>
            </tr>
            <tr>
              <th>Celular</th>
              <td>{{datosEmpleado?.telCel}}</td>
            </tr>
            <tr>
              <th>Correo</th>
              <td>{{datosEmpleado?.email}}</td>
            </tr>
            <tr>
              <th>Cargo</th>
              <td>{{datosEmpleado?.nomCar}}</td>
            </tr>
          </table>
          <div class="employee-actions">
            <button type="button" class="btn btn-success enviar-btn" (click)="generateAccountStatement()">
              Generar Estado de Cuenta
            </button>
          </div>
          <!-- Si no está validado -->
          <div class="nuevo-afiliado-exterior" *ngIf="!validado">
            <p class="nuevo-afiliado-msg text-center">
              ¿No perteneces al fondo?<br><strong>Haz click en el botón de abajo para asociarte.</strong>
            </p>
            <div class="employee-actions text-center">
              <button *ngIf="!mostrarFormularioAfiliado" type="button" class="btn btn-success"
                (click)="toggleFormularioAfiliado()">
                Nuevo Asociado
              </button>
              <div *ngIf="mostrarFormularioAfiliado" class="botones-accion-formulario">
                <button type="button" class="btn btn-success mr-2" (click)="guardarNuevoAfiliado()">Guardar
                  Afiliado</button>
                <button type="button" class="btn btn-secondary" (click)="limpiarFormularioAfiliado()"
                  [disabled]="!hayDatosEnFormulario()">
                  Limpiar
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- FORMULARIO NUEVO AFILIADO -->
        <div *ngIf="mostrarFormularioAfiliado" class="table-container nuevo-afiliado-formulario">
          <div class="nuevo-afiliado-header">
            <h4>FORMATO DE AFILIACION</h4>
          </div>
          <div class="nuevo-afiliado-body">
            <form>
              <!-- Acordeón 1: Datos Personales -->
              <div class="accordion-section">
                <div class="accordion-header" (click)="toggleSeccion('datosPersonales')">
                  <h5>DATOS PERSONALES</h5>
                  <span class="arrow" [class.rotated]="seccionesAbiertas.datosPersonales">&#9662;</span>
                </div>
                <div class="accordion-body" *ngIf="seccionesAbiertas.datosPersonales">
                  <!-- Fila 1 -->
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Documento</label>
                      <input type="number" class="form-control" [(ngModel)]="nuevoAfiliado.codAfi" name="codAfi"
                        required>
                    </div>
                    <div class="form-group col-md-4">
                      <label>Nombre</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.nomAfi" name="nomAfi"
                        (input)="nuevoAfiliado.nomAfi = nuevoAfiliado.nomAfi?.toUpperCase()" required>
                    </div>
                    <div class="form-group col-md-4">
                      <label>Primer Apellido</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.ap1Afi" name="ap1Afi"
                        (input)="nuevoAfiliado.ap1Afi = nuevoAfiliado.ap1Afi?.toUpperCase()" required>
                    </div>
                  </div>
                  <!-- Fila 2 -->
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Segundo Apellido</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.ap2Afi" name="ap2Afi"
                        (input)="nuevoAfiliado.ap2Afi = nuevoAfiliado.ap2Afi?.toUpperCase()">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Fecha Nacimiento</label>
                      <input type="date" class="form-control" [(ngModel)]="nuevoAfiliado.fecNac" name="fecNac" required>
                    </div>
                    <div class="form-group col-md-4">
                      <label>Estado Civil</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.estCiv" name="estCiv" required>
                        <option value="" disabled selected>Seleccione una opción</option>
                        <option *ngFor="let estado of estadosCiviles" [value]="estado">{{estado}}</option>
                      </select>
                    </div>
                  </div>
                  <!-- Fila 3 -->
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label>Cargo</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.cargo" name="nomCar"
                        (input)="nuevoAfiliado.nomCar = nuevoAfiliado.cargo?.toUpperCase()" required>
                    </div>
                    <div class="form-group col-md-6">
                      <label>Salario Básico</label>
                      <input type="number" class="form-control" [(ngModel)]="nuevoAfiliado.salBas" name="salBas" min="0"
                        required>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Acordeón 2: Contacto y Empresa -->
              <div class="accordion-section">
                <div class="accordion-header" (click)="toggleSeccion('contactoEmpresa')">
                  <h5>CONTACTO - EMPRESA</h5>
                  <span class="arrow" [class.rotated]="seccionesAbiertas.contactoEmpresa">&#9662;</span>
                </div>
                <div class="accordion-body" *ngIf="seccionesAbiertas.contactoEmpresa">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label>Empresa</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.nomEmp" name="nomEmp" required>
                        <option value="" disabled selected>Seleccione una empresa</option>
                        <option *ngFor="let empresa of empresas" [value]="empresa">{{empresa}}</option>
                      </select>
                    </div>
                    <div class="form-group col-md-6">
                      <label>Fecha Ingreso</label>
                      <input type="date" class="form-control" [(ngModel)]="nuevoAfiliado.fecIng" name="fecIng" required>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label>Dirección Residencia</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.dirRes" name="dirRes"
                        (input)="nuevoAfiliado.dirRes = nuevoAfiliado.dirRes?.toUpperCase()" required>
                    </div>
                    <div class="form-group col-md-6">
                      <label>Barrio</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.nomBar" name="nomBar"
                        (input)="nuevoAfiliado.nomBar = nuevoAfiliado.nomBar?.toUpperCase()" required>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label>Teléfono Celular</label>
                      <input type="number" class="form-control" [(ngModel)]="nuevoAfiliado.telCel" name="telCel"
                        required>
                    </div>
                    <div class="form-group col-md-6">
                      <label>Correo Electrónico</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.eMail" name="eMail"
                        (input)="nuevoAfiliado.eMail = nuevoAfiliado.eMail?.toUpperCase()" required>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Acordeón 3: Información Financiera -->
              <div class="accordion-section">
                <div class="accordion-header" (click)="toggleSeccion('infoFinanciera')">
                  <h5>INFORMACION FINANCIERA</h5>
                  <span class="arrow" [class.rotated]="seccionesAbiertas.infoFinanciera">&#9662;</span>
                </div>
                <div class="accordion-body" *ngIf="seccionesAbiertas.infoFinanciera">
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Tipo de Cuenta</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.ctaTipo" name="ctaTipo" required>
                        <option value="" disabled selected>Tipo de cuenta</option>
                        <option *ngFor="let tipo of tiposCuenta" [value]="tipo">{{tipo}}</option>
                      </select>
                    </div>
                    <div class="form-group col-md-4">
                      <label>Número de Cuenta</label>
                      <input type="number" class="form-control" [(ngModel)]="nuevoAfiliado.ctaBan" name="ctaBan"
                        required>
                    </div>
                    <div class="form-group col-md-4">
                      <label>Banco</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.fdoBan" name="fdoBan" required>
                        <option value="" disabled selected>Seleccione banco</option>
                        <option *ngFor="let banco of bancos" [value]="banco">{{banco}}</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label>Aporte Mensual (%)</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.apMes" name="apMes" required>
                        <option value="" disabled selected>% de aporte</option>
                        <option *ngFor="let porcentaje of porcentajes" [value]="porcentaje">{{porcentaje}}%</option>
                      </select>
                    </div>
                    <div class="form-group col-md-6">
                      <label>Deducción Nómina</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.periodoAporte" name="periodoAporte"
                        required>
                        <option value="" disabled selected>Seleccione periodo</option>
                        <option value="Q1">QUINCENA 1</option>
                        <option value="Q2">QUINCENA 2</option>
                        <option value="AMBAS">AMBAS</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Acordeón 4: Beneficiarios -->
              <div class="accordion-section">
                <div class="accordion-header" (click)="toggleSeccion('beneficiarios')">
                  <h5>BENEFICIARIOS</h5>
                  <span class="arrow" [class.rotated]="seccionesAbiertas.beneficiarios">&#9662;</span>
                </div>
                <div class="accordion-body" *ngIf="seccionesAbiertas.beneficiarios">
                  <label class="form-section-title">Beneficiario 1</label>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Documento</label>
                      <input type="number" class="form-control" [(ngModel)]="nuevoAfiliado.codBen1" name="codBen1">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Nombre</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.nomBen1" name="nomBen1"
                        (input)="nuevoAfiliado.nomBen1 = nuevoAfiliado.nomBen1?.toUpperCase()">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Parentesco</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.parBen1" name="parBen1">
                        <option value="" disabled selected>Seleccione</option>
                        <option *ngFor="let parentesco of parentescos" [value]="parentesco">{{parentesco}}</option>
                      </select>
                    </div>
                  </div>
                  <label class="form-section-title">Beneficiario 2 (Opcional)</label>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Documento</label>
                      <input type="number" class="form-control" [(ngModel)]="nuevoAfiliado.codBen2" name="codBen2">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Nombre</label>
                      <input type="text" class="form-control" [(ngModel)]="nuevoAfiliado.nomBen2" name="nomBen2"
                        (input)="nuevoAfiliado.nomBen2 = nuevoAfiliado.nomBen2?.toUpperCase()">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Parentesco</label>
                      <select class="form-control" [(ngModel)]="nuevoAfiliado.parBen2" name="parBen2">
                        <option value="" disabled selected>Seleccione</option>
                        <option *ngFor="let parentesco of parentescos" [value]="parentesco">{{parentesco}}</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
        <!-- /Formulario nuevo afiliado -->
        <!-- Información global -->
        <div class="global-info-box" *ngIf="datosEmpleado">
          <p>
            <strong>La información mostrada en el documento corresponde al mes anterior de su generación</strong><br>
            Ejemplo: Al generarse el estado de cuenta en el mes de Mayo, se mostrará hasta Abril del presente año.
          </p>
        </div>
      </div>
    </div>
    <!-- ============================ -->
    <!-- PESTAÑA: BUSCAR EMPLEADO -->
    <!-- ============================ -->
    <div *ngIf="adminTab === 'busqueda'">
      <input type="text" class="form-control buscador-principal" placeholder="Buscar por documento, nombre o apellidos"
        [(ngModel)]="filtroBusqueda" (input)="buscarEmpleado()" [disabled]="buscadorInhabilitado" />
      <!-- Búsqueda de empleados -->
      <div *ngIf="empleadosFiltrados.length > 0" class="busqueda-resultados mt-3">
        <div *ngFor="let emp of empleadosFiltrados" class="empleado-card-lista" (click)="editarEmpleado(emp)">
          <div class="empleado-info">
            <h5>{{emp.nomAso}} {{emp.ap1Aso}} {{emp.ap2Aso}}</h5>
            <p><i class="fas fa-id-card"></i> {{emp.codAso}}</p>
          </div>
          <div class="ver-detalle">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </div>
      <div *ngIf="empleadosFiltrados.length === 0 && filtroBusqueda" class="alert alert-danger mt-2">
        No se encontraron asociados.
      </div>
    </div>
    <!-- Detalle del empleado -->
    <div *ngIf="adminTab === 'busqueda' && mostrarFormularioAfiliado && nuevoAfiliado" class="card empleado-card mt-4">
      <div class="detalle-header">
        <h4>👤 {{nuevoAfiliado.nomAso}} {{nuevoAfiliado.ap1Aso}} {{nuevoAfiliado.ap2Aso}}</h4>
        <button class="btn-cerrar" (click)="cerrarDetalle()">×</button>
      </div>
      <div class="detalle-body">
        <div class="detalle-item"><i class="fas fa-id-card"></i> <strong>Documento:</strong> {{nuevoAfiliado.codAso}}
        </div>
        <div class="detalle-item"><i class="fas fa-briefcase"></i> <strong>Cargo:</strong> {{nuevoAfiliado.nomCar}}
        </div>
        <div class="detalle-item"><i class="fas fa-building"></i> <strong>Empresa:</strong> {{nuevoAfiliado.nomEmp}}
          ({{nuevoAfiliado.fecIng | date:'dd/MM/yyyy'}})</div>
        <div class="detalle-item"><i class="fas fa-map-marker-alt"></i> <strong>Dirección:</strong> {{
          nuevoAfiliado.dirRes}} - {{nuevoAfiliado.nomBar}}</div>
        <div class="detalle-item"><i class="fas fa-phone-alt"></i> <strong>Celular:</strong> {{nuevoAfiliado.telCel}}
        </div>
        <div class="detalle-item"><i class="fas fa-birthday-cake"></i> <strong>Fecha Nacimiento:</strong> {{
          nuevoAfiliado.fecNac | date:'dd/MM/yyyy'}}</div>
        <div class="detalle-item"><i class="fas fa-envelope"></i> <strong>Correo:</strong> {{nuevoAfiliado.email ||
          nuevoAfiliado.eMail}}</div>
        <div class="detalle-item"><i class="fas fa-heart"></i> <strong>Estado Civil:</strong> {{nuevoAfiliado.estCivil
          }}</div>
        <div class="detalle-item"><i class="fas fa-money-bill-wave"></i> <strong>Salario Básico:</strong> {{
          nuevoAfiliado.salBas | currency:'COP'}}</div>
        <div class="detalle-item"><i class="fas fa-piggy-bank"></i> <strong>Banco:</strong> {{nuevoAfiliado.ctaBan}} -
          {{nuevoAfiliado.ctaTipo}} {{nuevoAfiliado.fdoBan}}</div>
        <div class="detalle-item"><i class="fas fa-percentage"></i> <strong>Fecha Afiliación:</strong> {{
          nuevoAfiliado.fecAfi | date:'dd/MM/yyyy'}}</div>
        <div class="detalle-item"><i class="fas fa-check-circle"></i> <strong>Aporta Q1/Q2:</strong> {{
          nuevoAfiliado.apPer1 ? 'Sí' : 'No'}} / {{nuevoAfiliado.apPer2 ? 'Sí' : 'No'}} ({{nuevoAfiliado.apMes}}%)
        </div>
      </div>
    </div>
    <!-- ============================ -->
    <!-- PESTAÑA: SOLICITUDES -->
    <!-- ============================ -->
    <div *ngIf="adminTab === 'solicitudes'">
      <div *ngIf="solicitudesAfiliacion.length === 0" class="alert alert-warning">
        No hay solicitudes de afiliación registradas.
      </div>
      <div class="row">
        <div class="col-xs-12 col-md-6" *ngFor="let solicitud of solicitudesAfiliacion; let i = index">
          <div class="ticket">
            <!-- Vista normal -->
            <div *ngIf="tarjetaEnConfirmacion !== i">
              <div class="row">
                <div class="col-sm-4">
                  <div class="date"><b>{{solicitud.fecha}}</b></div>
                </div>
                <div class="col-sm-4">
                  <div class="ticket-num"><b>AFILIACIÓN #{{i + 1}}</b></div>
                </div>
                <div class="col-sm-4 text-right">
                  <div class="assigned-employee">{{solicitud.nomEmp}}</div>
                </div>
              </div>
              <hr>
              <div class="row mt-2">
                <div class="col-sm-12">
                  <p><b>Nombre Completo:</b> {{solicitud.nomAfi}} {{solicitud.ap1Afi}} {{solicitud.ap2Afi}}</p>
                  <p><b>Documento:</b> {{solicitud.codAfi}}</p>
                  <p><b>Celular:</b> {{solicitud.telCel}}</p>
                  <p><b>Correo:</b> {{solicitud.eMail?.toLowerCase()}}</p>
                </div>
              </div>
              <div class="ticket-actions">
                <button class="btn btn-danger btn-block" (click)="mostrarConfirmacionInline(i, 'AFILIADO(A)')"
                  [disabled]="accionesEnProgreso[i]">
                  Aprobar
                </button>
                <button class="btn btn-secondary btn-block" (click)="mostrarConfirmacionInline(i, 'RECHAZADO(A)')"
                  [disabled]="accionesEnProgreso[i]">
                  Rechazar
                </button>
              </div>
            </div>
            <!-- Vista confirmación -->
            <div *ngIf="tarjetaEnConfirmacion === i" class="confirmacion-card text-center">
              <p>¿Deseas
                <strong>{{accionPendiente === 'AFILIADO(A)' ? 'aprobar' : 'rechazar'}}</strong>
                la solicitud de <b>{{solicitud.nomAfi}} {{solicitud.ap1Afi}}</b>?
              </p>
              <div class="d-flex justify-content-around mt-3">
                <button class="btn btn-danger" (click)="confirmarAccionSolicitud(i)"
                  [disabled]="!accionPendiente">Confirmar</button>
                <button class="btn btn-outline-secondary" (click)="cancelarConfirmacion()">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
